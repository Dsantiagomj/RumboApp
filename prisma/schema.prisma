generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String? // Hashed with Argon2
  name          String?
  image         String?
  colombianId   String? // CC, CE, Pasaporte number
  colombianIdType ColombianIdType? @default(CC)
  dateOfBirth   DateTime? // Collected during onboarding
  phoneNumber   String? // Collected during onboarding
  onboardingCompletedAt DateTime? // Timestamp when onboarding was completed
  nickname      String? // For AI personalization
  role          UserRole  @default(USER)

  // Preferences
  currency      String    @default("COP")
  locale        String    @default("es-CO")
  timezone      String    @default("America/Bogota")
  theme         String    @default("light") // light | dark | system

  // Relations
  accounts       Account[]
  sessions       Session[]
  financialAccounts FinancialAccount[]
  transactions   Transaction[]
  categories     Category[]
  budgets        Budget[]
  bills          Bill[]
  aiChatSessions AIChatSession[]
  passwordResetTokens PasswordResetToken[]
  importJobs     ImportJob[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // Soft delete

  @@index([email])
  @@index([deletedAt])
}

enum UserRole {
  USER
  ADMIN
}

enum ColombianIdType {
  CC        // C√©dula de Ciudadan√≠a
  CE        // C√©dula de Extranjer√≠a
  PASAPORTE // Pasaporte
}

// NextAuth models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ============================================================================
// FINANCIAL ACCOUNTS
// ============================================================================

model FinancialAccount {
  id            String   @id @default(cuid())
  userId        String

  name          String // "Bancolombia Ahorros", "Nequi"
  bankName      String? // "Bancolombia", "Nequi"
  accountNumber String? // Masked: "****1234"
  accountType   AccountType
  currency      String   @default("COP")

  // Appearance
  color         String   @default("#6366f1") // Hex color for UI
  icon          String? // Icon name (lucide-react)

  // Balance
  initialBalance Decimal  @default(0) @db.Decimal(12, 2)
  currentBalance Decimal  @default(0) @db.Decimal(12, 2)

  // Credit card fields
  creditLimit    Decimal? @db.Decimal(12, 2)
  availableCredit Decimal? @db.Decimal(12, 2)

  // Loan fields
  loanAmount        Decimal? @db.Decimal(12, 2)
  remainingBalance  Decimal? @db.Decimal(12, 2)
  monthlyPayment    Decimal? @db.Decimal(12, 2)

  // Tracking
  isManual       Boolean   @default(true) // true = manual, false = imported
  lastSyncedAt   DateTime? // When last imported from file

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime? // Soft delete

  @@index([userId])
  @@index([deletedAt])
}

enum AccountType {
  SAVINGS      // Cuenta de ahorros
  CHECKING     // Cuenta corriente
  CREDIT_CARD  // Tarjeta de cr√©dito
  LOAN         // Pr√©stamo
  CASH         // Efectivo
  INVESTMENT   // Inversi√≥n
  OTHER        // Otro
}

// ============================================================================
// TRANSACTIONS
// ============================================================================

model Transaction {
  id            String   @id @default(cuid())
  userId        String
  accountId     String

  amount        Decimal  @db.Decimal(12, 2)
  currency      String   @default("COP")
  exchangeRate  Decimal? @db.Decimal(10, 4) // For multi-currency support

  description   String
  merchant      String? // Store/merchant name

  categoryId    String?

  type          TransactionType
  status        TransactionStatus @default(CLEARED)

  date          DateTime

  // For transfers between accounts
  transferToAccountId String?
  linkedTransactionId String? // Link to opposite side of transfer

  // Additional metadata
  notes         String?
  tags          String[] // Flexible tagging
  receiptUrl    String? // URL to receipt image (Cloudflare R2)

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  account       FinancialAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category      Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime? // Soft delete

  @@index([userId])
  @@index([accountId])
  @@index([categoryId])
  @@index([date])
  @@index([type])
  @@index([deletedAt])
}

enum TransactionType {
  INCOME    // Income
  EXPENSE   // Expense
  TRANSFER  // Transfer between accounts
}

enum TransactionStatus {
  PENDING     // Pending (not yet cleared)
  CLEARED     // Cleared
  RECONCILED  // Reconciled (matched with bank statement)
}

// ============================================================================
// CATEGORIES
// ============================================================================

model Category {
  id            String   @id @default(cuid())
  userId        String?  // null = system category (default Colombian categories)

  name          String
  nameEs        String? // Spanish name
  icon          String   @default("üìå") // Emoji or lucide icon name
  color         String   @default("#6366f1") // Hex color

  type          TransactionType @default(EXPENSE)

  // Parent category for subcategories (future)
  parentId      String?

  // Relations
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]
  budgets       Budget[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime? // Soft delete

  @@index([userId])
  @@index([type])
  @@index([deletedAt])
}

// ============================================================================
// BUDGETS
// ============================================================================

model Budget {
  id            String   @id @default(cuid())
  userId        String
  categoryId    String

  name          String
  amount        Decimal  @db.Decimal(12, 2)
  currency      String   @default("COP")

  period        BudgetPeriod @default(MONTHLY)

  // Period dates
  startDate     DateTime
  endDate       DateTime

  // Rollover unused budget to next period
  rollover      Boolean  @default(false)

  // Alert thresholds (percentage)
  alertAt       Int?     @default(80) // Alert at 80% spent

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category      Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime? // Soft delete

  @@index([userId])
  @@index([categoryId])
  @@index([startDate, endDate])
  @@index([deletedAt])
}

enum BudgetPeriod {
  WEEKLY
  MONTHLY
  YEARLY
  CUSTOM
}

// ============================================================================
// BILLS (Recurring)
// ============================================================================

model Bill {
  id            String   @id @default(cuid())
  userId        String

  name          String // "Codensa (Electricidad)", "Claro (Internet)"
  description   String?

  amount        Decimal  @db.Decimal(12, 2)
  currency      String   @default("COP")

  categoryId    String? // Link to Servicios category

  frequency     BillFrequency @default(MONTHLY)

  // Billing dates
  dueDay        Int // Day of month (1-31)

  // Reminders
  reminderDays  Int      @default(3) // Remind 3 days before

  // Auto-pay
  autoPay       Boolean  @default(false)
  accountId     String? // Account to auto-pay from

  // Status
  isActive      Boolean  @default(true)

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  instances     BillInstance[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime? // Soft delete

  @@index([userId])
  @@index([isActive])
  @@index([deletedAt])
}

enum BillFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

// Bill instances (generated monthly)
model BillInstance {
  id            String   @id @default(cuid())
  billId        String

  dueDate       DateTime
  amount        Decimal  @db.Decimal(12, 2)

  status        BillStatus @default(PENDING)

  paidDate      DateTime?
  paidAmount    Decimal? @db.Decimal(12, 2)

  // Link to transaction when paid
  transactionId String?

  // Relations
  bill          Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([billId])
  @@index([dueDate])
  @@index([status])
}

enum BillStatus {
  PENDING
  PAID
  OVERDUE
  SKIPPED
}

// ============================================================================
// AI CHAT
// ============================================================================

model AIChatSession {
  id            String   @id @default(cuid())
  userId        String

  title         String? // Auto-generated or user-set

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages      AIChatMessage[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime? // Soft delete

  @@index([userId])
  @@index([deletedAt])
}

model AIChatMessage {
  id            String   @id @default(cuid())
  sessionId     String

  role          MessageRole
  content       String   @db.Text

  // Function calling metadata
  functionName  String?
  functionArgs  Json?
  functionResult Json?

  // Relations
  session       AIChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())

  @@index([sessionId])
  @@index([createdAt])
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  FUNCTION
}

// ============================================================================
// FILE IMPORT
// ============================================================================

model ImportJob {
  id        String   @id @default(cuid())
  userId    String

  fileName  String
  fileSize  Int
  fileUrl   String
  fileType  FileType

  status    ImportJobStatus @default(PENDING)
  progress  Int      @default(0)

  // Password handling
  passwordHash String? // Encrypted password for this job only (cleared after processing)
  requiresPassword Boolean @default(false)
  passwordAttempts Int @default(0)

  bankFormat BankFormat?
  error     String?
  accountsCount Int @default(0)
  transactionsCount Int @default(0)

  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  importedAccounts ImportedAccount[]
  importedTransactions ImportedTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  completedAt DateTime?

  @@index([userId])
  @@index([status])
}

model ImportedAccount {
  id        String   @id @default(cuid())
  importJobId String

  name      String
  bankName  String?
  accountNumber String?
  accountType AccountType

  initialBalance Decimal @db.Decimal(12, 2)
  transactionCount Int @default(0)

  // AI-suggested metadata
  suggestedColor String?
  suggestedIcon String?
  confidence Float? // AI confidence (0-1)

  // User decision
  isConfirmed Boolean @default(false)
  confirmedAccountId String? // Linked to FinancialAccount if confirmed

  importJob ImportJob @relation(fields: [importJobId], references: [id], onDelete: Cascade)
  transactions ImportedTransaction[]

  createdAt DateTime @default(now())

  @@index([importJobId])
}

model ImportedTransaction {
  id        String   @id @default(cuid())
  importJobId String
  importedAccountId String

  date      DateTime
  description String
  amount    Decimal @db.Decimal(12, 2)
  type      TransactionType
  merchant  String?

  // Original data from file
  rawData   Json?

  // AI-suggested category
  suggestedCategoryId String?
  confidence Float? // AI confidence (0-1)

  // User decision
  isConfirmed Boolean @default(false)
  confirmedTransactionId String? // Linked to Transaction if confirmed

  importJob ImportJob @relation(fields: [importJobId], references: [id], onDelete: Cascade)
  importedAccount ImportedAccount @relation(fields: [importedAccountId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([importJobId])
  @@index([importedAccountId])
  @@index([date])
}

enum FileType {
  CSV
  PDF
  IMAGE
}

enum ImportJobStatus {
  PENDING
  PROCESSING
  PARSING
  CATEGORIZING
  REVIEW
  CONFIRMED
  FAILED
  CANCELLED
}

enum BankFormat {
  BANCOLOMBIA
  NEQUI
  DAVIVIENDA
  BBVA
  BANCO_BOGOTA
  GENERIC
}
